#!/bin/bash
set -e

GREEN='\e[32m'
BLUE='\e[34m'
YELLOW='\e[33m'
RED='\e[31m'
END='\e[0m'

log() {
  echo -e "${GREEN}[+] $1${END}"
}

info() {
  echo -e "${BLUE}[i] $1${END}"
}

warn() {
  echo -e "${YELLOW}[!] $1${END}"
}

error() {
  echo -e "${RED}[x] $1${END}"
}

TARGET_FILE="/etc/lsyncd/targets.conf"
WATCH_SCRIPT="/root/watch_reload.sh"
WATCH_FILE="/usr/local/lsws/conf/httpd_config.conf"
RELOAD_CMD="/usr/local/lsws/bin/lswsctrl reload"
SSH_KEY="/root/.ssh/id_rsa"

FOLDERS=(
    "/etc/ssl/example-certs"
    "/root/.acme.sh"
    "/usr/local/lsws/conf"
    "/var/www"
)

mapfile -t TARGETS < "$TARGET_FILE"

log "Updating /etc/lsyncd/lsyncd.conf.lua..."
cat > /etc/lsyncd/lsyncd.conf.lua <<'EOF'
settings {
    logfile = "/var/log/lsyncd/lsyncd.log",
    statusFile = "/var/log/lsyncd/lsyncd.status",
    statusInterval = 10,
    nodaemon = false,
}
EOF

for FOLDER in "${FOLDERS[@]}"; do
  for TARGET in "${TARGETS[@]}"; do
    cat >> /etc/lsyncd/lsyncd.conf.lua <<EOF

sync {
    default.rsync,
    source = "$FOLDER/",
    target = "$TARGET:$FOLDER/",
    rsync = {
        archive = true,
        compress = true,
        verbose = true,
        rsh = "ssh -i $SSH_KEY -o StrictHostKeyChecking=no"
    }
}
EOF
  done
done

log "Restarting Lsyncd..."
systemctl restart lsyncd

log "Restarting Watcher script..."
pkill -f watch_reload.sh || true
nohup "$WATCH_SCRIPT" > /var/log/watch_reload.log 2>&1 &

log "‚úÖ Targets updated and Lsyncd reloaded!"

# Function to get LiteSpeed last reload time
get_litespeed_reload_time() {
    local target="$1"

    # Try multiple methods to get the reload time
    local reload_time

    # Method 1: Check LiteSpeed process start time
    reload_time=$(ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@"$target" \
        "ps -eo pid,lstart,cmd | grep '[l]itespeed' | head -1 | awk '{print \$3, \$4, \$5, \$6}'" 2>/dev/null)

    if [[ -n "$reload_time" ]]; then
        echo "$reload_time"
        return 0
    fi

    # Method 2: Check LiteSpeed log for reload entries
    reload_time=$(ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@"$target" \
        "tail -20 /usr/local/lsws/logs/error.log 2>/dev/null | grep -i 'graceful\|reload\|restart' | tail -1 | awk '{print \$1, \$2}'" 2>/dev/null)

    if [[ -n "$reload_time" ]]; then
        echo "$reload_time"
        return 0
    fi

    # Method 3: Check system log
    reload_time=$(ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@"$target" \
        "journalctl -u lsws --no-pager -n 5 2>/dev/null | grep -E 'Started|Reloaded' | tail -1 | awk '{print \$1, \$2, \$3}'" 2>/dev/null)

    if [[ -n "$reload_time" ]]; then
        echo "$reload_time"
        return 0
    fi

    echo "Unable to determine"
    return 1
}

# Function to calculate time difference
calculate_time_diff() {
    local reload_time="$1"
    local current_time=$(date +%s)

    if [[ "$reload_time" == "Unable to determine" ]]; then
        echo "Unknown"
        return 1
    fi

    # Try to convert reload time to timestamp
    local reload_timestamp
    reload_timestamp=$(date -d "$reload_time" +%s 2>/dev/null)

    if [[ $? -eq 0 ]]; then
        local diff=$((current_time - reload_timestamp))

        if [[ $diff -lt 60 ]]; then
            echo "${diff} seconds ago"
        elif [[ $diff -lt 3600 ]]; then
            echo "$((diff / 60)) minutes ago"
        elif [[ $diff -lt 86400 ]]; then
            echo "$((diff / 3600)) hours ago"
        else
            echo "$((diff / 86400)) days ago"
        fi
    else
        echo "Unable to calculate"
    fi
}

log "üîÑ Sending LiteSpeed reload to all configured child servers..."

# Store reload results
declare -A reload_results
declare -A reload_success

for TARGET in "${TARGETS[@]}"; do
  echo "[‚Üí] Reloading on $TARGET..."

  if ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@"$TARGET" "$RELOAD_CMD" 2>/dev/null; then
    echo "[‚úî] Reload command sent to $TARGET"
    reload_success["$TARGET"]="yes"
  else
    echo "[‚úò] Failed to send reload command to $TARGET"
    reload_success["$TARGET"]="no"
  fi
done

log "‚è≥ Waiting 5 seconds before checking reload status..."
sleep 5

log "üîç Checking actual reload status of all child servers..."

echo ""
info "==================== RELOAD STATUS REPORT ===================="
printf "%-20s %-15s %-25s %-20s\n" "SERVER" "RELOAD_SENT" "LAST_RELOAD_TIME" "TIME_AGO"
echo "----------------------------------------------------------------"

for TARGET in "${TARGETS[@]}"; do
  if [[ "${reload_success[$TARGET]}" == "yes" ]]; then
    reload_status="‚úÖ SUCCESS"
  else
    reload_status="‚ùå FAILED"
  fi

  info "Checking $TARGET..."

  # Get the actual reload time from the server
  reload_time=$(get_litespeed_reload_time "$TARGET")
  time_ago=$(calculate_time_diff "$reload_time")

  printf "%-20s %-15s %-25s %-20s\n" "$TARGET" "$reload_status" "$reload_time" "$time_ago"
done

echo "================================================================"
echo

# ======== Summary Section ========
set +e

echo ""
successful_reloads=0
failed_reloads=0

for TARGET in "${TARGETS[@]}"; do
  if [[ "${reload_success[$TARGET]}" == "yes" ]]; then
    ((successful_reloads++))
  else
    ((failed_reloads++))
  fi
done

if [[ $failed_reloads -eq 0 ]]; then
  log "üéâ All $successful_reloads server(s) reloaded successfully!"
else
  warn "‚ö†Ô∏è  $successful_reloads server(s) reloaded successfully, $failed_reloads failed"
fi

log "‚úÖ Script execution completed!"

set -e
